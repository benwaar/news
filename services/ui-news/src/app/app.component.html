<h1>News UI (Angular)</h1>
<!-- Env indicator and subtle dev background overlay -->
<div class="env-indicator" [class.dev]="isDev" [class.prod]="!isDev">{{ envLabel }}</div>
<div class="api-indicator">{{ apiLabel }}</div>
<div class="dev-cascade" *ngIf="isDev"></div>
<div class="spaced">
  <label for="authMode">Auth Mode:&nbsp;</label>
  <select id="authMode" (change)="onModeChange($event)">
    <option *ngFor="let m of authModes" [selected]="m===authMode" [value]="m">{{ m }}</option>
  </select>
  <span *ngIf="authMode!=='plain'" style="margin-left:8px">(scaffolded; plain mode active)</span>
  <span *ngIf="authMode==='plain'" style="margin-left:8px">(plain manual PKCE)</span>
  </div>
<div class="badge">Realm: <strong>news</strong>
  <button (click)="login()" *ngIf="!loggedIn" [disabled]="authMode!=='plain'">Login</button>
  <button (click)="logout()" *ngIf="loggedIn" [disabled]="authMode!=='plain'">Logout</button>
</div>

<!-- Main tabs: Basics / JWT Lab -->
<div class="tabs">
  <div class="tab-list">
    <button *ngFor="let t of mainTabs"
            class="tab"
            [class.active]="selectedMainTab===t.id"
            (click)="selectMainTab(t.id)">{{ t.label }}</button>
  </div>

  <!-- Basics tab content (existing functionality) -->
  <div class="tab-content" *ngIf="selectedMainTab==='basics'">
    <h2>Basics</h2>
    <p>API health via UI proxy:</p>
    <pre>{{ health | json }}</pre>
    <div *ngIf="loggedIn">
      <p class="spaced">
        <a [href]="accountUrl" target="_blank" rel="noopener noreferrer">Open Account Console</a>
      </p>
      <p>
        <button (click)="validateToken()" [disabled]="!accessToken || authMode!=='plain'">Validate Token</button>
        <button (click)="fetchRss()" [disabled]="!accessToken || authMode!=='plain'">Fetch RSS</button>
        <button (click)="toggleToken()" [disabled]="!accessToken">{{ showToken ? 'Hide' : 'Show' }} Token</button>
        <button (click)="copyToken()" [disabled]="!accessToken || authMode!=='plain'">Copy Token</button>
        <button (click)="adminPing()" [disabled]="!accessToken || authMode!=='plain'">Admin Ping</button>
      </p>
      <p *ngIf="accessTokenExp">
        Token expires at: {{ accessTokenExp * 1000 | date:'medium' }}
        <br />
        Expires in: {{ accessTokenExpiresIn }}s
      </p>
      <div *ngIf="showToken && accessToken">
        <h3>Access Token (debug)</h3>
        <textarea rows="6" readonly>{{ accessToken }}</textarea>
        <h4>Decoded Claims</h4>
        <pre>{{ tokenPayload | json }}</pre>
        <div class="spaced">
          <h4>Claims Checklist (dev)</h4>
          <ul>
            <li>Header alg (Algorithm): <strong>{{ basicsClaims.alg || 'n/a' }}</strong></li>
            <li>[iss] Issuer present: <strong [style.color]="basicsClaims.issOk ? 'green' : 'crimson'">{{ basicsClaims.issOk ? 'yes' : 'no' }}</strong></li>
            <li>[aud] Audience: <strong>{{ basicsClaims.aud ? basicsClaims.aud.join(', ') : 'n/a' }}</strong></li>
            <li>[sub] Subject present: <strong [style.color]="basicsClaims.subOk ? 'green' : 'crimson'">{{ basicsClaims.subOk ? 'yes' : 'no' }}</strong></li>
            <li>[exp] Expires valid (not expired): <strong [style.color]="basicsClaims.expOk ? 'green' : 'crimson'">{{ basicsClaims.expOk ? 'yes' : 'no' }}</strong></li>
            <li>Roles/Groups: <strong>{{ basicsClaims.roles ? basicsClaims.roles.join(', ') : 'n/a' }}</strong></li>
          </ul>
        </div>
      </div>
      <div *ngIf="tokenValidation">
        <h3>Token Validation</h3>
        <pre>{{ tokenValidation | json }}</pre>
      </div>
      <div *ngIf="rss">
        <h3>RSS (via API)</h3>
        <pre>{{ rss | json }}</pre>
      </div>
      <div *ngIf="adminPingStatus !== null">
        <h3>Admin Ping</h3>
        <p>Status: {{ adminPingStatus }}</p>
        <pre>{{ adminPingResponse | json }}</pre>
      </div>
    </div>
    <div *ngIf="error" class="error">{{ error }}</div>
  </div>

<hr />
  <!-- JWT Lab tabs grouped under main tab -->
  <div class="tab-content" *ngIf="selectedMainTab==='jwt-lab'">
    <h2>JWT Lab</h2>

<div class="tabs">
  <div class="tab-list">
    <button *ngFor="let t of labTabs"
            class="tab"
            [class.active]="selectedLabTab===t.id"
            (click)="selectLabTab(t.id)">
      {{ t.label }}
      <span *ngIf="!t.ready" title="Coming soon">(soon)</span>
    </button>
  </div>

  <!-- HS256 (basic) tab -->
  <div class="tab-content" *ngIf="selectedLabTab==='hs256-basic'">
    <h3>HS256 (Basic)</h3>
    <div class="warning">
      Educational only: HS256 in-browser puts the signing secret in JS.
      Real IdPs (e.g., Keycloak) sign tokens server-side (RS256). We use HS256 here
      to make JWT structure and signing tangible in one page.
    </div>
    <div class="info-panel">
      <h4>Glossary</h4>
      <ul>
        <li><strong>JWT</strong>: header + payload + signature (base64url segments).</li>
        <li><strong>HS256</strong>: HMAC-SHA256 over <em>header.payload</em> using a shared secret.</li>
        <li><strong>base64url</strong>: URL-safe base64 without padding.</li>
        <li><strong>exp</strong>: Expiration (Unix seconds). Token invalid after this time.</li>
        <li><strong>iat</strong>: Issued-at (Unix seconds).</li>
        <li><strong>sub</strong>: Subject (stable user identifier).</li>
      </ul>
    </div>
    <div class="info-panel">
      <p>
        This tab demonstrates the anatomy of a JWT and what the signature actually protects. You build
        base64url(header).base64url(payload) and sign that exact string, so changing either part breaks the signature.
        We also surface common claims like <code>sub</code>, <code>exp</code>, and <code>iat</code> so you can see how
        they affect token validity (e.g., an <code>exp</code> countdown). Because HS256 uses a shared secret, putting the
        signer in the browser is only for learning — real systems keep secrets server-side and avoid exposing them to JS.
      </p>
    </div>
    <div>
      <label>Secret:&nbsp;</label>
      <input type="text" [(ngModel)]="labSecret" placeholder="secret" style="width: 240px;" />
    </div>
    <div class="spaced">
      <label>TTL (seconds):&nbsp;</label>
      <input type="number" [(ngModel)]="labTtl" min="0" style="width: 120px;" />
    </div>
    <div>
      <label>Payload (JSON):</label>
      <textarea rows="6" [(ngModel)]="labPayloadText" placeholder='{"sub":"123","name":"Alice"}'></textarea>
    </div>
    <p>
      <button (click)="labGenerate()">Generate JWT (HS256)</button>
    </p>
    <div>
      <label>Token:</label>
      <textarea rows="4" [(ngModel)]="labInput" placeholder="<header>.<payload>.<signature>"></textarea>
    </div>
    <p>
      <button (click)="labDecode()">Decode</button>
      <button (click)="labVerifyNow()">Verify (HS256)</button>
      <span *ngIf="labVerify !== null" [style.color]="labVerify ? 'green' : 'crimson'">{{ labVerify ? 'signature valid' : 'invalid signature' }}</span>
      <span *ngIf="labError" class="error" style="margin-left: 12px;">{{ labError }}</span>
    </p>
    <p class="spaced">
      <a href="https://www.jwt.io/" target="_blank" rel="noopener noreferrer">Open jwt.io (decode/inspect)</a>
    </p>
    <div class="grid">
      <div>
        <h4>Decoded Header</h4>
        <pre>{{ labDecodedHeader | json }}</pre>
      </div>
      <div>
        <h4>Decoded Payload</h4>
        <pre>{{ labDecodedPayload | json }}</pre>
        <p *ngIf="labExpiresIn !== null">Expires in: {{ labExpiresIn }}s</p>
        <div class="spaced">
          <h4>Claims Checklist (dev)</h4>
          <ul>
            <li>Header alg (Algorithm): <strong>{{ labDecodedHeader?.alg || 'n/a' }}</strong></li>
            <li>[sub] Subject present: <strong [style.color]="labDecodedPayload?.sub ? 'green' : 'crimson'">{{ labDecodedPayload?.sub ? 'yes' : 'no' }}</strong></li>
            <li>[exp] Expires present: <strong [style.color]="(labDecodedPayload?.exp !== undefined) ? 'green' : 'crimson'">{{ (labDecodedPayload?.exp !== undefined) ? 'yes' : 'no' }}</strong></li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- RS256 + JWKS placeholder -->
  <div class="tab-content" *ngIf="selectedLabTab==='rs256-jwks'">
    <h3>RS256 + JWKS</h3>
    <div class="warning">Dev-only: Verify RS256 signatures in the browser with JWKS. Real verification should happen in your API.</div>
    <div class="info-panel">
      <h4>Glossary</h4>
      <ul>
        <li><strong>RS256</strong>: RSA with SHA-256; asymmetric signing (private key) and verification (public key).</li>
        <li><strong>kid</strong>: Key ID in the JWT header to select the correct public key.</li>
        <li><strong>JWKS</strong>: JSON Web Key Set published by the issuer; contains public keys.</li>
        <li><strong>iss</strong>: Issuer URL; should match your realm.</li>
        <li><strong>aud</strong>: Audience; should include your API/client as intended recipient.</li>
      </ul>
    </div>
    <div class="info-panel">
      <p>
        RS256 uses asymmetric keys: Keycloak signs with a private key and publishes matching public keys via JWKS.
        The token header contains a <code>kid</code> to select the right key. Your API normally fetches JWKS and verifies
        the signature server-side, then checks claims like <code>iss</code>, <code>aud</code>, and <code>exp</code>.
        Here we replicate that flow only for study: decode to get <code>kid</code>, fetch the realm JWKS, and verify the
        signature against the selected public key.
      </p>
    </div>
    <div>
      <label>Token:</label>
      <textarea rows="4" [(ngModel)]="rsTokenInput" placeholder="paste a Keycloak access token"></textarea>
    </div>
    <p>
      <button (click)="rsDecodeToken()">Decode + Extract kid</button>
      <span *ngIf="rsKid">kid: <strong>{{ rsKid }}</strong></span>
    </p>
    <p>
      <button (click)="rsFetchJwks()">Fetch JWKS (realm)</button>
      <button (click)="rsVerifyWithJwks()" [disabled]="!rsKid || rsJwks.length===0">Verify (RS256 + JWKS)</button>
      <span *ngIf="rsVerify !== null" [style.color]="rsVerify ? 'green' : 'crimson'">{{ rsVerify ? 'signature valid' : 'invalid signature' }}</span>
      <span *ngIf="rsError" class="error" style="margin-left: 12px;">{{ rsError }}</span>
    </p>
    <div class="grid">
      <div>
        <h4>Decoded Header</h4>
        <pre>{{ rsDecodedHeader | json }}</pre>
      </div>
      <div>
        <h4>Decoded Payload</h4>
        <pre>{{ rsDecodedPayload | json }}</pre>
      </div>
    </div>
  </div>

  <!-- OIDC Code+PKCE placeholder -->
  <div class="tab-content" *ngIf="selectedLabTab==='oidc-pkce'">
    <h3>OIDC Code + PKCE</h3>
    <p>Coming soon: step through the browser code flow, show <code>code_verifier</code>/<code>code_challenge</code>, and capture tokens after the token endpoint exchange.</p>
  </div>

  <!-- Interceptor: Attach placeholder -->
  <div class="tab-content" *ngIf="selectedLabTab==='interceptor'">
    <h3>HTTP Interceptor: Attach</h3>
    <p>Coming soon: allowlist API origins and automatically attach <code>Authorization: Bearer &lt;access_token&gt;</code> to API calls.</p>
  </div>

  <!-- Refresh flow placeholder -->
  <div class="tab-content" *ngIf="selectedLabTab==='refresh'">
    <h3>401 → Refresh → Retry</h3>
    <p>Coming soon: single refresh-in-flight guard, queue concurrent requests, and safe retry logic without loops or storms.</p>
  </div>

  <!-- Storage options placeholder -->
  <div class="tab-content" *ngIf="selectedLabTab==='storage'">
    <h3>Storage Options</h3>
    <p>Coming soon: compare in-memory, sessionStorage, localStorage, and HttpOnly cookies (via BFF) with their tradeoffs and XSS/CSRF implications.</p>
  </div>

  <!-- Idle vs Expiry placeholder -->
  <div class="tab-content" *ngIf="selectedLabTab==='idle'">
    <h3>Idle vs Expiration</h3>
    <p>Coming soon: show token expiration vs user idle session timers and how to implement idle logout UX.</p>
  </div>

  <!-- Multi-tab sync placeholder -->
  <div class="tab-content" *ngIf="selectedLabTab==='multitab'">
    <h3>Multi-Tab Sync</h3>
    <p>Coming soon: coordinate auth state with BroadcastChannel, avoid refresh races, and propagate logout.</p>
  </div>
  </div>
</div>
