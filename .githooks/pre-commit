#!/usr/bin/env zsh
set -euo pipefail

# Prevent committing common secrets/certs
STAGED=( $(git diff --cached --name-only) )
BLOCKED_PATTERNS=( '*.pem' '*.key' '*.crt' '*.env' '*.env.*' )

for f in $STAGED; do
  for pat in $BLOCKED_PATTERNS; do
    if [[ $f == $pat ]]; then
      echo "Pre-commit blocked: refusing to commit sensitive file '$f'" >&2
      echo "If intentional, commit with --no-verify (not recommended)." >&2
      exit 1
    fi
  done
done

# Optional: basic size guard (>5MB files)
for f in $STAGED; do
  if [[ -f $f ]]; then
    size=$(wc -c < "$f")
    if (( size > 5*1024*1024 )); then
      echo "Pre-commit blocked: '$f' is larger than 5MB" >&2
      exit 1
    fi
  fi
done

# All good
echo "Running pre-commit checks..." >&2

# JavaScript syntax check for Node services
JS_SERVICES=( services/api services/rss-mcp )
for svc in $JS_SERVICES; do
  for f in $STAGED; do
    if [[ $f == $svc/src/*.js ]]; then
      echo "Syntax check: $f" >&2
      node --check "$f"
    fi
  done
done

# TypeScript typecheck for Angular UI (fast, no emit)
if [[ -f services/ui/tsconfig.app.json ]]; then
  echo "Typecheck: services/ui (tsc --noEmit)" >&2
  pushd services/ui >/dev/null
  npm exec -- tsc -p tsconfig.app.json --noEmit
  popd >/dev/null
fi

echo "Pre-commit passed." >&2
exit 0
